<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Сканер кода с камеры</title>
<style>
  /* Общие стили */
  body {
    font-family: monospace, monospace;
    padding: 15px;
    margin: 0;
    background: #fafafa;
    color: #222;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  h2 {
    font-size: 1.5rem;
    margin-bottom: 15px;
    text-align: center;
  }

  button {
    font-size: 1.3rem;
    padding: 14px 20px;
    margin: 10px 0;
    width: 100%;
    max-width: 350px;
    border: none;
    border-radius: 10px;
    background-color: #1976d2;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: block;
    box-shadow: 0 3px 6px rgba(25, 118, 210, 0.3);
  }

  button:disabled {
    background-color: #9e9e9e;
    cursor: not-allowed;
    box-shadow: none;
  }

  button:not(:disabled):active {
    background-color: #115293;
  }

  #qr-reader {
    margin: 10px auto 20px;
    width: 100vw;
    max-width: 350px;
    height: auto !important;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    overflow: hidden;
  }

  h3 {
    margin-top: 0;
    font-weight: 600;
    font-size: 1.2rem;
    text-align: center;
  }

  #output {
    max-width: 350px;
    margin: 0 auto 20px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid #ddd;
    padding: 15px;
    text-align: center;
    min-height: 70px;
    box-shadow: inset 0 1px 3px #ccc;
    word-wrap: break-word;
    user-select: text;
  }

  /* Символы */
  .char {
    display: inline-block;
    border: 1px solid #ddd;
    padding: 6px 8px;
    margin: 3px 4px;
    border-radius: 8px;
    font-size: 1.1rem;
    user-select:none;
    min-width: 28px;
  }

  .char small {
    display: block;
    font-size: 0.7rem;
    margin-top: 3px;
    color: #555;
  }

  .ctrl {
    background: #ffebee;
    color: #b00020;
    font-weight: 700;
  }

  /* Адаптивность */
  @media (max-width: 400px) {
    button {
      font-size: 1.1rem;
      padding: 12px 16px;
      max-width: 100%;
    }
    #qr-reader, #output {
      max-width: 100vw;
      border-radius: 0;
      margin: 10px 0 15px;
    }
  }
</style>
</head>
<body>

<h2>Сканер кода с камеры телефона</h2>

<button id="start-camera-btn">Включить камеру</button>
<button id="switch-camera-btn" disabled>Переключить камеру</button>

<div id="qr-reader" style="display:none;"></div>

<h3>Результат чтения (символы и их коды):</h3>
<div id="output">[Пусто]</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const output = document.getElementById('output');
  const startBtn = document.getElementById('start-camera-btn');
  const switchBtn = document.getElementById('switch-camera-btn');
  const qrReaderElem = document.getElementById('qr-reader');

  function printableChar(ch) {
    const code = ch.charCodeAt(0);
    if (code === 32) return "' '"; // пробел
    if (ch === '\n') return '\\n';
    if (ch === '\r') return '\\r';
    if (ch === '\t') return '\\t';
    if (code < 32 || code === 127) {
      const names = {
        0: 'NUL', 1: 'SOH', 2: 'STX', 3: 'ETX', 4: 'EOT',
        5: 'ENQ', 6: 'ACK', 7: 'BEL', 8: 'BS', 9: 'TAB',
        10:'LF', 11:'VT', 12:'FF', 13:'CR', 14:'SO', 15:'SI',
        16:'DLE',17:'DC1',18:'DC2',19:'DC3',20:'DC4',
        21:'NAK',22:'SYN',23:'ETB',24:'CAN',25:'EM',
        26:'SUB',27:'ESC',28:'FS',29:'GS',30:'RS',31:'US',
        127:'DEL'
      };
      return names[code] || `0x${code.toString(16).toUpperCase()}`;
    }
    return ch.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function showResult(text) {
    output.innerHTML = '';
    for(let i=0; i < text.length; i++) {
      const ch = text[i];
      const code = text.charCodeAt(i);
      const span = document.createElement('span');
      span.classList.add('char');
      if(code < 32 || code === 127) span.classList.add('ctrl');
      span.innerHTML = printableChar(ch) + '<small>' + code + '</small>';
      output.appendChild(span);
    }
    if(text.length === 0) output.textContent = '[Пусто]';
  }

  function onScanSuccess(decodedText, decodedResult) {
    console.log(`Считано: ${decodedText}`);
    showResult(decodedText);
  }

  function onScanFailure(error) {
    // ошибки игнорируем
  }

  let html5QrcodeScanner;
  let cameraStarted = false;
  let cameras = [];
  let currentCameraIndex = 0;

  startBtn.addEventListener('click', () => {
    if(cameraStarted) return;

    html5QrcodeScanner = new Html5Qrcode("qr-reader");

    Html5Qrcode.getCameras().then(cams => {
      if(cams && cams.length) {
        cameras = cams;

        currentCameraIndex = cams.findIndex(cam => cam.label.toLowerCase().includes("back"));
        if(currentCameraIndex === -1) currentCameraIndex = 0;

        startCamera(cameras[currentCameraIndex].id);

        if(cameras.length > 1) {
          switchBtn.disabled = false;
        }

      } else {
        alert("Камеры не найдены.");
      }
    }).catch(err => {
      console.error(`Ошибка при получении камер: ${err}`);
      alert("Ошибка при получении камер: " + err);
    });
  });

  switchBtn.addEventListener('click', () => {
    if(!cameraStarted || cameras.length < 2) return;

    html5QrcodeScanner.stop().then(() => {
      currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
      startCamera(cameras[currentCameraIndex].id);
    }).catch(err => {
      console.error("Ошибка остановки камеры:", err);
      alert("Ошибка при переключении камеры: " + err);
    });
  });

  function startCamera(cameraId) {
    qrReaderElem.style.display = 'block';

    html5QrcodeScanner.start(
      cameraId,
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      onScanFailure
    ).then(() => {
      cameraStarted = true;
      startBtn.disabled = true;
      startBtn.textContent = "Камера включена";
      const label = cameras[currentCameraIndex].label || `Камера ${currentCameraIndex + 1}`;
      switchBtn.textContent = `Переключить камеру (Сейчас: ${label})`;
    }).catch(err => {
      console.error(`Не удалось запустить камеру: ${err}`);
      alert("Ошибка запуска камеры: " + err);
    });
  }
</script>

</body>
</html>

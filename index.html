<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Сканер кода с камеры (смена камеры)</title>
<style>
  body { font-family: monospace; padding: 20px; }
  #qr-reader {
    width: 300px;
    margin-bottom: 10px;
  }
  #output {
    border: 1px solid #ccc;
    padding: 10px;
    white-space: pre-wrap;
  }
  .char {
    display:inline-block;
    border:1px solid #ddd;
    padding: 2px 6px;
    margin: 2px;
    border-radius:3px;
    user-select:none;
  }
  .ctrl {
    background:#ffdddd;
    color:#aa0000;
    font-weight:bold;
  }
  #controls {
    margin-bottom: 10px;
  }
  button {
    margin-right: 10px;
    padding: 6px 12px;
  }
</style>
</head>
<body>

<h2>Сканер кода с камеры телефона</h2>

<div id="controls">
  <button id="start-camera-btn">Включить камеру</button>
  <button id="switch-camera-btn" disabled>Сменить камеру</button>
</div>

<div id="qr-reader" style="display:none;"></div>

<h3>Результат чтения (символы и их коды):</h3>
<div id="output">[Пусто]</div>

<script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
<script>
  const output = document.getElementById('output');
  const startBtn = document.getElementById('start-camera-btn');
  const switchBtn = document.getElementById('switch-camera-btn');
  const qrReaderElem = document.getElementById('qr-reader');

  let html5QrcodeScanner;
  let cameras = [];
  let currentCameraIndex = 0;
  let cameraStarted = false;

  function printableChar(ch) {
    const code = ch.charCodeAt(0);
    if (code === 32) return "' '"; // пробел
    if (ch === '\n') return '\\n';
    if (ch === '\r') return '\\r';
    if (ch === '\t') return '\\t';
    if (code < 32 || code === 127) {
      const names = {
        0: 'NUL', 1: 'SOH', 2: 'STX', 3: 'ETX', 4: 'EOT',
        5: 'ENQ', 6: 'ACK', 7: 'BEL', 8: 'BS', 9: 'TAB',
        10:'LF', 11:'VT', 12:'FF', 13:'CR', 14:'SO', 15:'SI',
        16:'DLE',17:'DC1',18:'DC2',19:'DC3',20:'DC4',
        21:'NAK',22:'SYN',23:'ETB',24:'CAN',25:'EM',
        26:'SUB',27:'ESC',28:'FS',29:'GS',30:'RS',31:'US',
        127:'DEL'
      };
      return names[code] || `0x${code.toString(16).toUpperCase()}`;
    }
    return ch.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function showResult(text) {
    output.innerHTML = '';
    for(let i=0; i < text.length; i++) {
      const ch = text[i];
      const code = text.charCodeAt(i);
      const span = document.createElement('span');
      span.classList.add('char');
      if(code < 32 || code === 127) span.classList.add('ctrl');
      span.innerHTML = printableChar(ch) + '<br><small>' + code + '</small>';
      output.appendChild(span);
    }
    if(text.length === 0) output.textContent = '[Пусто]';
  }

  function onScanSuccess(decodedText, decodedResult) {
    console.log(`Считано: ${decodedText}`);
    showResult(decodedText);
  }

  function onScanFailure(error) {
    // ошибки можно игнорировать
  }

  async function startCameraById(cameraId) {
    if(cameraStarted && html5QrcodeScanner) {
      await html5QrcodeScanner.stop();
      cameraStarted = false;
    }
    qrReaderElem.style.display = 'block';

    try {
      await html5QrcodeScanner.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanFailure
      );
      cameraStarted = true;
      startBtn.disabled = true;
      startBtn.textContent = "Камера включена";
      switchBtn.disabled = cameras.length < 2;
    } catch (err) {
      console.error(`Не удалось запустить камеру: ${err}`);
      alert("Ошибка запуска камеры: " + err);
    }
  }

  startBtn.addEventListener('click', async () => {
    html5QrcodeScanner = new Html5Qrcode("qr-reader");

    try {
      cameras = await Html5Qrcode.getCameras();
      if(!cameras || cameras.length === 0) {
        alert("Камеры не найдены.");
        return;
      }

      // Предпочитаем заднюю камеру, если есть
      currentCameraIndex = 0;
      for(let i=0; i < cameras.length; i++) {
        if(cameras[i].label.toLowerCase().includes("back")) {
          currentCameraIndex = i;
          break;
        }
      }

      await startCameraById(cameras[currentCameraIndex].id);

    } catch (err) {
      console.error(`Ошибка при получении камер: ${err}`);
      alert("Ошибка при получении камер: " + err);
    }
  });

  switchBtn.addEventListener('click', async () => {
    if(!cameraStarted || cameras.length < 2) return;
    currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
    await startCameraById(cameras[currentCameraIndex].id);
  });
</script>

</body>
</html>
